{"version":3,"file":"defaultConfigLoader.esm.js","sources":["../../src/app/defaultConfigLoader.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\nimport { AppConfigLoader } from './types';\n\n/**\n * The default config loader, which expects that config is available at compile-time\n * in `process.env.APP_CONFIG`. APP_CONFIG should be an array of config objects as\n * returned by the config loader.\n *\n * It will also load runtime config from the __APP_INJECTED_RUNTIME_CONFIG__ string,\n * which can be rewritten at runtime to contain an additional JSON config object.\n * If runtime config is present, it will be placed first in the config array, overriding\n * other config values.\n *\n * @public\n */\nexport const defaultConfigLoader: AppConfigLoader = async () =>\n  defaultConfigLoaderSync();\n\n/** @internal */\nexport function defaultConfigLoaderSync(\n  // This string may be replaced at runtime to provide additional config.\n  // It should be replaced by a JSON-serialized config object.\n  // It's a param so we can test it, but at runtime this will always fall back to default.\n  runtimeConfigJson: string = '__APP_INJECTED_RUNTIME_CONFIG__',\n) {\n  const appConfig = process.env.APP_CONFIG;\n  if (!appConfig) {\n    throw new Error('No static configuration provided');\n  }\n  if (!Array.isArray(appConfig)) {\n    throw new Error('Static configuration has invalid format');\n  }\n  const configs = appConfig.slice() as unknown as AppConfig[];\n\n  // Avoiding this string also being replaced at runtime\n  if (\n    runtimeConfigJson !==\n    '__app_injected_runtime_config__'.toLocaleUpperCase('en-US')\n  ) {\n    try {\n      const data = JSON.parse(runtimeConfigJson) as JsonObject;\n      if (Array.isArray(data)) {\n        configs.push(...data);\n      } else {\n        configs.push({ data, context: 'env' });\n      }\n    } catch (error) {\n      throw new Error(`Failed to load runtime configuration, ${error}`);\n    }\n  }\n\n  const windowAppConfig = (window as any).__APP_CONFIG__;\n  if (windowAppConfig) {\n    configs.push({\n      context: 'window',\n      data: windowAppConfig,\n    });\n  }\n  return configs;\n}\n"],"names":[],"mappings":"AAgCa,MAAA,mBAAA,GAAuC,YAClD,uBAAwB,GAAA;AAGV,SAAA,uBAAA,CAId,oBAA4B,iCAC5B,EAAA;AACA,EAAM,MAAA,SAAA,GAAY,QAAQ,GAAI,CAAA,UAAA,CAAA;AAC9B,EAAA,IAAI,CAAC,SAAW,EAAA;AACd,IAAM,MAAA,IAAI,MAAM,kCAAkC,CAAA,CAAA;AAAA,GACpD;AACA,EAAA,IAAI,CAAC,KAAA,CAAM,OAAQ,CAAA,SAAS,CAAG,EAAA;AAC7B,IAAM,MAAA,IAAI,MAAM,yCAAyC,CAAA,CAAA;AAAA,GAC3D;AACA,EAAM,MAAA,OAAA,GAAU,UAAU,KAAM,EAAA,CAAA;AAGhC,EAAA,IACE,iBACA,KAAA,iCAAA,CAAkC,iBAAkB,CAAA,OAAO,CAC3D,EAAA;AACA,IAAI,IAAA;AACF,MAAM,MAAA,IAAA,GAAO,IAAK,CAAA,KAAA,CAAM,iBAAiB,CAAA,CAAA;AACzC,MAAI,IAAA,KAAA,CAAM,OAAQ,CAAA,IAAI,CAAG,EAAA;AACvB,QAAQ,OAAA,CAAA,IAAA,CAAK,GAAG,IAAI,CAAA,CAAA;AAAA,OACf,MAAA;AACL,QAAA,OAAA,CAAQ,IAAK,CAAA,EAAE,IAAM,EAAA,OAAA,EAAS,OAAO,CAAA,CAAA;AAAA,OACvC;AAAA,aACO,KAAO,EAAA;AACd,MAAA,MAAM,IAAI,KAAA,CAAM,CAAyC,sCAAA,EAAA,KAAK,CAAE,CAAA,CAAA,CAAA;AAAA,KAClE;AAAA,GACF;AAEA,EAAA,MAAM,kBAAmB,MAAe,CAAA,cAAA,CAAA;AACxC,EAAA,IAAI,eAAiB,EAAA;AACnB,IAAA,OAAA,CAAQ,IAAK,CAAA;AAAA,MACX,OAAS,EAAA,QAAA;AAAA,MACT,IAAM,EAAA,eAAA;AAAA,KACP,CAAA,CAAA;AAAA,GACH;AACA,EAAO,OAAA,OAAA,CAAA;AACT;;;;"}